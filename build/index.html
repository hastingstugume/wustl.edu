<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive YouTube Video Quiz</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 0;
      }
      #heading-container {
        text-align: center; /* Center the heading */
        margin: 20px 0;
      }
      #video {
        width: 100%;
        height: 60vh; /* Video occupies half the page */
        position: relative;
      }
      #note-response-container {
        display: none;
        justify-content: space-between;
        margin: 10px;
        padding: 10px;
      }
      .text-box {
        width: 95%;
        height: 140px; /* Increased height for better usability */
        padding: 10px;
        margin: 0px 5px;
        font-size: 16px;
        border: 2px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        resize: none;
      }
      #user-id-popup {
        position: absolute;
        top: 10; /* 10 below */
        left: 0;
        width: 100%;
        height: 40vh; /* Matches video size */
        background-color: rgba(71, 137, 128, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1;
      }
      #user-id-popup label,
      #user-id-popup input,
      #user-id-popup button {
        margin: 10px;
        padding: 5px;
        font-size: 24px;
      }
      #user-id-popup input {
        width: 300px;
        height: 40px;
      }
      #start-button {
        background-color: #007bff;
        color: #fff;
        border: none;
        width: 150px;
        height: 50px;
        cursor: pointer;
        border-radius: 5px;
      }
      @media (max-width: 768px) {
        .question-container {
          width: 90%;
          height: 90vh;
        }
        #user-id-popup #userId {
          width: 80%;
        }
      }
      @media (max-width: 480px) {
        .question-container {
          width: 95%;
          height: 95vh;
        }
        #user-id-popup #userId {
          width: 80%;
        }
      }
      .question {
        color: white;
        background-color: black;
        border: 1px solid;
        border-color: rgb(145, 145, 145);
        border-radius: 5px;
        padding: 10px;
      }
      input[type='text'] {
        width: 98%;
        height: 90px;
        font-size: 24px;
        margin-right: 10px;
        margin-bottom: 10px;
        padding-left: 10px;
      }
      #submit {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        font-size: 18px;
        margin-top: 10px;
        border-radius: 5px;
      }
      #submit:hover {
        background-color: #0056b3;
      }
      #container1 {
        left: 10px;
        display: none; /* Default state hidden */
        background-color: rgba(52, 152, 219, 0.5);
        width: 30%; /* Reduce width to 30% of the parent container */
        max-width: 300px; /* Set a maximum width for better control */
        padding: 10px; /* Optional: Add padding for content spacing */
      }

      #container2 {
        right: 10px;
        display: none; /* Default state hidden */
        background-color: rgba(231, 76, 60, 0.9);
        border: 1px solid;
        border-radius: 10px; /* Rounded corners */
      }

      textarea {
        width: 97%; /* Takes full width of the container */
        height: 50px; /* Increased height for better readability */
        font-size: 15px;
        margin-top: 5px; /* Adds spacing from previous elements */
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none; /* Prevents manual resizing */
      }

      .con {
        display: flex;
        align-items: center;
        margin-bottom: 10px; /* Adds space between options */
      }

      .con p {
        margin-left: 10px; /* Adds spacing between checkbox and label */
      }

      .overlay-container {
        position: absolute;
        top: 10px;
        width: 45%; /* Ensures containers are proportionally sized */
        height: auto; /* Adjust height to fit the content */
        max-height: 90vh; /* Prevents containers from growing too tall */
        overflow-y: auto; /* Adds scroll if content overflows */
        z-index: 3; /* Above the overlay */
        background-color: rgba(
          0,
          0,
          0,
          0.7
        ); /* Dark background for readability */
        color: white;
        padding: 20px; /* Increased padding for better spacing */
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Adds subtle shadow */
      }

      .answer-group {
        margin-bottom: 10px; /* Spacing between answers */
      }

      .answer-group label {
        font-size: 15px;
        color: white;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .answer-group input[type='checkbox'] {
        margin-right: 10px; /* Space between checkbox and label text */
        width: 20px;
        height: 20px;
      }

      .answer-group textarea {
        width: 97%; /* Takes full width of the container */
        height: 50px; /* Sets height for uniform appearance */
        font-size: 16px;
        margin-top: 5px; /* Adds spacing from previous elements */
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none; /* Prevents manual resizing */
        background-color: #fff;
      }

      .button-container {
        text-align: right; /* Aligns the button to the right */
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
      }

      button:hover {
        background-color: #0056b3; /* Slightly darker on hover */
      }
      #video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
        z-index: 2; /* Higher than video but lower than other containers */
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 20px;
      }

      #video-container {
        position: relative;
        width: 100%;
        height: 60vh; /* Matches video height */
      }

      /* Styling for the instructions modal */
      #instructions-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 100;
        background-color: rgba(
          173,
          216,
          230,
          0.2
        ); /* Light blue with transparency */
        color: black;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border: 2px solid rgba(173, 216, 230, 1); /* Light blue border */
        width: 95%;
        max-width: 900px;
        text-align: left;
        overflow-y: auto;
        max-height: 80vh;
      }

      #instructions-modal h2 {
        margin-top: 0;
        color: #007bff;
        font-size: 22px;
      }

      #instructions-modal p {
        margin: 10px 0;
        line-height: 1.5;
      }

      #instructions-modal ul {
        margin: 10px 0;
        padding-left: 0;
        list-style-type: none;
      }

      #instructions-modal ul li {
        margin: 10px 0;
      }

      #instructions-modal ul li input {
        margin-right: 10px; /* Space between checkbox and label text */
        width: 15px;
        height: 15px;
      }

      #instructions-modal button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
      }

      #instructions-modal button:hover {
        background-color: #0056b3;
      }

      ul {
        list-style-type: disc; /* Default bullet style */
        margin: 0; /* Remove margin around the list */
        padding: 0; /* Remove padding around the list */
      }

      li {
        font-size: 1em; /* Make the font size larger */
        line-height: 1.5; /* Add space between lines */
        margin-bottom: 10px; /* Add space between bullet points */
      }
    </style>
  </head>
  <body>
    <div id="heading-container">
      <h2 id="heading">
        Please enter your Connect ID to proceed.<br />
        This is the same number you entered at the beginning of the study.
      </h2>
    </div>

    <!-- Box for user ID -->
    <div id="user-id-popup">
      <input type="text" id="userId" placeholder="Connect ID" />
      <div class="submit-button">
        <button id="start-button">Start</button>
      </div>
    </div>

    <!-- Box for instructions -->
    <div id="instructions-modal">
      <h2 id="modal-title">Instructions</h2>
      <div id="modal-content"></div>
      <button id="accept-button">Start Lecture</button>
    </div>

    <!-- Error message in case of wrong answers -->
    <div
      id="error-popup"
      style="
        display: none;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: red;
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 9999;
      "
    >
      Error message will appear here.
    </div>

    <!-- Video container -->
    <div id="video-container">
      <div id="video"></div>
      <div id="video-overlay"></div>
    </div>

    <!-- Box for additional question popup -->
    <div id="container1" class="overlay-container">
      <p id="qtn" class="question">Additional Question</p>
      <textarea
        id="responseBox"
        placeholder="Please provide a complete response here..."
      ></textarea>
      <div class="button-container">
        <button type="button" id="additional">Send</button>
      </div>
    </div>

    <!-- the question popup that pauses the video -->
    <div id="container2" class="overlay-container">
      <p id="question" class="question">
        What were you thinking about right before you saw this prompt? (Please
        select both options if they apply)
      </p>
      <div class="answer-group">
        <label>
          <input type="checkbox" name="choice" value="A" id="A" />
          Something related to the information being presented in the video
          lecture
        </label>
        <!-- Placeholder for explaining your response -->
        <textarea
          id="answerInput1"
          placeholder="Please specify in a phrase or sentence..."
        ></textarea>
      </div>
      <div class="answer-group">
        <label>
          <input type="checkbox" name="choice" value="B" id="B" />
          Something else
        </label>
        <!-- Placeholder for explaining your response -->
        <textarea
          id="answerInput2"
          placeholder="Please specify in a phrase or sentence..."
        ></textarea>
      </div>
      <div class="button-container">
        <button id="submit">Continue</button>
      </div>
    </div>

    <!-- Box for taking notes -->
    <div id="note-response-container">
      <!-- Placeholder for taking notes -->
      <textarea
        id="noteBox"
        class="text-box"
        placeholder="Please take notes here..."
      ></textarea>
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
      import {
        getFirestore,
        collection,
        addDoc,
        getDoc,
        updateDoc,
        doc,
      } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';

      // Firebase configuration
      const firebaseConfig = {
        apiKey: 'API_KEY',
        authDomain: 'interactive-video-app.firebaseapp.com',
        projectId: 'interactive-video-app',
        storageBucket: 'interactive-video-app.appspot.com',
        messagingSenderId: 'MESSAGING_ID',
        appId: 'APP_ID',
        measurementId: 'MSMNT_ID',
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // additional questions
      const additionalQuestions = [
        'What are your plans for the weekend?',
        'Do you have any tips for preparing for an exam?',
        'How do you stay focused while studying or learning?',
        'How do you usually plan your vacations?',
        'What are some of your hobbies?',
        'What are your favorite places to eat?',
        'How do you stay connected with friends or family?',
        'Where are the best places you’ve ever travelled to?',
        'What’s your favorite way to document your travels?',
        'How do you stay updated on the latest trends?',
        'What’s the most exciting thing you’ve done this year?',
        'How do you balance screen time with other activities?',
        'How do you usually make new friends or connections?',
        'What’s a fun fact about yourself that surprises people?',
        'How do you like to explore a new city or town?',
        'How do you usually celebrate your birthday?',
        'What’s your favorite childhood memory?',
        'How do you like to spend your free time?',
      ];

      // Randomly decide the layout
      const layout = await updateAndReturnMaxScenario();
      const randomLayout =
        layout === 'S1'
          ? '1'
          : layout === 'S2'
          ? '2'
          : layout === 'S3'
          ? '3'
          : layout === 'S3'
          ? '4'
          : '0';
      console.log(randomLayout);
      const displayTimes = [];
      let currentQuestionIndex = 0;

      let player;
      const questionContainer = document.getElementById('question-container');
      const question = document.getElementById('question');
      const answerOption1 = document.getElementById('A');
      const answerOption2 = document.getElementById('B');
      const answerInput1 = document.getElementById('answerInput1');
      const answerInput2 = document.getElementById('answerInput2');
      const submitButton = document.getElementById('submit');
      const additionalQtnBtn = document.getElementById('additional');
      const userID = document.getElementById('userId');
      const questionPopup = document.getElementById('question-popup');

      // Instructions for each scenario
      const instructionsData = {
        1: {
          title: 'Please read these instructions carefully!!!',
          content: `
              <p>Welcome to Phase 1! You will be learning about the Earth, earthquakes, and volcanoes.
                The program will present a video lecture (~35-40 minutes) from a geological science course. Please treat the video lecture as if you were watching it for a course that you are taking and try to learn the information presented in it.</p>
              <li>Do NOT pause, rewind, or skip parts of, the video. While you are watching the video, thought probes will interrupt the lecture occasionally, automatically pausing it and asking about what you are thinking. Please enter your responses to resume the lecture. Kindly respond to all the probes honestly.</li>
              <li>Do NOT take notes or engage in any other task(s) during the lecture. Just focus on learning the information being presented in the lecture.</li>
              <li>You will not be able to move to the next section until after the lecture is complete (~35-40 minutes). After the video finishes, the program will automatically close the browser tab and advance the study to the next section. Please return to the previous tab (i.e., the Qualtrics survey) to continue with the study.</li>
              <li>During Phase 2 of the study, you will be asked to answer some questions about the information presented in the lecture.</li>
              <p>Do you have any questions? If so, please contact the researcher at <strong>3145831948</strong> or <strong>m.zubeiru@wustl.edu.</strong></p>
              <p>Before you proceed to watch the lecture, please answer the question below to make sure that you understood the instructions.</p>
              <p><strong>Which of the following is correct? (select all that apply)</strong></p>
              <ul>
                <li><label><input type="checkbox" value="A"> I need to treat the video lecture as I would if watching for a course that I am taking because I will be tested afterwards.</label></li>
                <li><label><input type="checkbox" value="B"> I should respond to all thought probes that will interrupt the lecture occasionally, asking me about what I am thinking.</label></li>
                <li><label><input type="checkbox" value="C"> There will be four videos, total.</label></li>
                <li><label><input type="checkbox" value="D"> I should not take notes or engage in any other tasks during the lecture.</label></li>
                <li><label><input type="checkbox" value="E"> This tab will automatically close once the video finishes, and I will have to return to the previous tab to continue with the study.</label></li>
                <li><label><input type="checkbox" value="F"> I am not allowed to pause, rewind or skip parts of the video lecture.</label></li>
                </ul>
                <br/>

                <p><strong><i>Click "Start Lecture" below to watch the video</i></p>
            `,
          correctAnswers: ['A', 'B', 'D', 'E', 'F'],
        },
        2: {
          title: 'Please read these instructions carefully!!!',
          content: `
              <p>Welcome to Phase 1! You will be learning about the Earth, earthquakes, and volcanoes.
                The program will present a video lecture from a geological science course. Please treat the video lecture as if you were watching it for a course that you are taking and try to learn the information presented in it.</p>
              <li>Do NOT pause, rewind, or skip parts of, the video. While you are watching the video, thought probes will interrupt the lecture occasionally, automatically pausing it and asking about what you are thinking. Please enter your responses to resume the lecture. Kindly respond to all the probes honestly.</li>
              <li>A textbox will be provided below the lecture video for you to take notes during the lecture. Please take notes in the way that you normally would do during a lecture in typical college classes. Your notes will be automatically saved once the video finishes. Please be assured that your notes will be kept confidential and used solely for the purpose of this research study.</li>
              <li>Do NOT engage in any other tasks (e.g., browsing the web) other than taking notes and responding to the thought probes.</li>
              <li>You will not be able to move to the next section until after the lecture is complete (~35-40 minutes). After the video finishes, the program will automatically close the browser tab and advance the study to the next section. Please return to the previous tab (i.e., the Qualtrics survey) to continue with the study.</li>
              <li>During Phase 2 of the study, you will be asked to answer some questions about the information presented in the lecture.</li>
              <p>Do you have any questions? If so, please contact the researcher at <strong>3145831948</strong> or <strong>m.zubeiru@wustl.edu.</strong></p>
              <p>Before you proceed to watch the lecture, please answer the question below to make sure that you understood the instructions.</p>
              <p><strong>Which of the following is correct? (select all that apply)</strong></p>
              <ul>
                <li><label><input type="checkbox" value="A"> I need to treat the video lecture as I would if watching for a course that I am taking because I will be tested afterwards.</label></li>
                <li><label><input type="checkbox" value="B"> I will be able to rewatch the video after completing the study.</label></li>
                <li><label><input type="checkbox" value="C"> I should respond to all thought probes that will interrupt the lecture occasionally, asking me about what I am thinking.</label></li>
                <li><label><input type="checkbox" value="D"> I am not allowed to engage in any other tasks during the lecture other than taking notes and responding to the thought probes.</label></li>
                <li><label><input type="checkbox" value="E"> This tab will automatically close once the video finishes, and I will have to return to the previous tab to continue with the study.</label></li>
                <li><label><input type="checkbox" value="F"> I am not allowed to pause, rewind or skip parts of the video lecture.</label></li>
                </ul>
                <br/>

                <p><strong><i>Click "Start Lecture" below to watch the video</i></p>
            `,
          correctAnswers: ['A', 'C', 'D', 'E', 'F'],
        },
        3: {
          title: 'Please read these instructions carefully!!!',
          content: `
              <p>Welcome to Phase 1! You will be learning about the Earth, earthquakes, and volcanoes.
                The program will present a video lecture (~35-40 minutes) from a geological science course. Please treat the video lecture as if you were watching it for a course that you are taking and try to learn the information presented in it.</p>
              <li>Do NOT pause, rewind, or skip parts of, the video. While you are watching the video, thought probes will appear on the right side of the screen, automatically pausing the lecture occasionally and asking about what you are thinking. Please enter your responses to resume the lecture. Kindly respond to all the probes honestly.</li>
              <li>Along with the thought probes, you will respond to pop-up messages appearing on the top left side of the screen during the lecture. Treat these as chat messages from a friend, providing a clear and detailed response to each message within ONE minute (1 Min) before it disappears. If unsure, please create a plausible response; do NOT say "No" or “I don’t know.”</li>
              <li>Do NOT take notes or engage in any other tasks (e.g., browsing the web) during the lecture other than responding to the thought probes and chat messages.</li>
              <li>You will not be able to move to the next section until after the lecture is complete (~35-40 minutes). After the video finishes, the program will automatically close the browser tab and advance the study to the next section. Please return to the previous tab (i.e., the Qualtrics survey) to continue with the study.</li>
              <li>During Phase 2 of the study, you will be asked to answer some questions about the information presented in the lecture.</li>
              <p>Do you have any questions? If so, please contact the researcher at <strong>3145831948</strong> or <strong>m.zubeiru@wustl.edu.</strong></p>
              <p>Before you proceed to watch the lecture, please answer the question below to make sure that you understood the instructions.</p>
              <p><strong>Which of the following is correct? (select all that apply)</strong></p>
              <ul>
                <li><label><input type="checkbox" value="A" id="A"> I need to treat the video lecture as I would if watching for a course that I am taking because I will be tested afterwards.</label></li>
                <li><label><input type="checkbox" value="B" id="B"> I should respond to all chat messages and thought probes that will interrupt the lecture occasionally.</label></li>
                <li><label><input type="checkbox" value="C" id="C"> I am not allowed to take notes or engage in any other tasks during the lecture other than responding to the chat messages and thought probes.</label></li>
                <li><label><input type="checkbox" value="D" id="D"> This tab will automatically close after the video finishes, and I will have to return to the previous tab to continue with the study.</label></li>
                <li><label><input type="checkbox" value="E" id="E"> I will receive a transcript of the lecture after watching it to review the content.</label></li>
                <li><label><input type="checkbox" value="F" id="F"> I am not allowed to pause, rewind or skip parts of the video lecture.</label></li>
                </ul>
                <br/>

                <p><strong><i>Click "Start Lecture" below to watch the video</i></p>
            `,
          correctAnswers: ['A', 'B', 'C', 'D', 'F'],
        },
        4: {
          title: 'Please read these instructions carefully!!!',
          content: `
              <p>Welcome to Phase 1! You will be learning about the Earth, earthquakes, and volcanoes.
                The program will present a video lecture from a geological science course. Please treat the video lecture as if you were watching it for a course that you are taking and try to learn the information presented in it.</li>
              <li>Do NOT pause, rewind, or skip parts of, the video. While you are watching the video, thought probes will appear on the right side of the screen, automatically pausing the lecture occasionally and asking about what you are thinking. Please enter your responses to resume the lecture. Kindly respond to all the probes honestly.</li>
              <li>Along with the thought probes, you will respond to pop-up messages appearing on the top left side of the screen during the lecture. Treat these as chat messages from a friend, providing a clear and detailed response to each message within ONE minute (1 min) before it disappears. If unsure, please create a plausible response; do NOT say "No" or “I don’t know.”</li>
              <li>A textbox will be provided below the lecture video for you to take notes during the lecture. Please take notes in the way that you normally would do during a lecture in typical college classes. Your notes will be automatically saved once the video finishes. Please be assured that your notes will be kept confidential and used solely for the purpose of this research study.</li>
              <li>Do NOT engage in any other tasks (e.g., browsing the web) during the lecture other than taking notes and responding to the thought probes and chat messages.</li>
              <li>You will not be able to move to the next section until after the lecture is complete (~35-40 minutes). After the video finishes, the program will automatically close the browser tab and advance the study to the next section. Please return to the previous tab (i.e., the Qualtrics survey) to continue with the study.</li>
              <li>During Phase 2 of the study, you will be asked to answer some questions about the information presented in the lecture.</li>
              <p>Do you have any questions? If so, please contact the researcher at <strong>3145831948</strong> or <strong>m.zubeiru@wustl.edu.</strong></p>
              <p>Before you proceed to watch the lecture, please answer the question below to make sure that you understood the instructions.</p>
              <p><strong>Which of the following is correct? (select all that apply)</strong></p>
              <ul>
                <li><label><input type="checkbox" value="A"> I need to treat the video lecture as I would if watching for a course that I am taking because I will be tested afterwards.</label></li>
                <li><label><input type="checkbox" value="B"> I should respond to all chat messages and thought probes that will interrupt the lecture occasionally.</label></li>
                <li><label><input type="checkbox" value="C"> I am not allowed to engage in any other tasks during the lecture other than taking notes and responding to the chat messages and thought probes.</label></li>
                <li><label><input type="checkbox" value="D"> This tab will automatically close after the video lecture finishes, and I will have to return to the previous tab to continue with the study.</label></li>
                <li><label><input type="checkbox" value="E"> I am not allowed to pause, rewind or skip parts of the video lecture.</label></li>
                <li><label><input type="checkbox" value="F"> The video lecture will provide captions that I can turn on or off at any time.</label></li>
                </ul>
                <br/>

                <p><strong><i>Click "Start Lecture" below to watch the video</i></p>
            `,
          correctAnswers: ['A', 'B', 'C', 'D', 'E'],
        },
      };

      let videoDuration = 240; // Total duration of the video in seconds
      const numPauses = 4;
      let questionPauseTimes = evenlyDistributedPauseTimes(
        numPauses,
        videoDuration
      );
      const userIdPopup = document.getElementById('user-id-popup');
      const startButton = document.getElementById('start-button');
      const headingContainer = document.getElementById('heading-container');

      // Show instructions based on the scenario
      startButton.addEventListener('click', () => {
        const userId = document.getElementById('userId').value.trim();
        if (!userId) {
          alert('Please enter your Connect ID to start.');
          return;
        }

        // Hide User ID Input and Show Instructions
        userIdPopup.style.display = 'none';
        headingContainer.style.display = 'none';
        document.getElementById('instructions-modal').style.display = 'block';
        showInstructions(randomLayout);
      });

      // Check for internet connectivity
      function isOnline() {
        return navigator.onLine;
      }

      // start the survey
      document.getElementById('accept-button').addEventListener('click', () => {
        if (!isOnline()) {
          showErrorMessage(
            'No internet connection. Please check your connection and try again.'
          );
          return; // Stop execution if offline
        }
        const modal = document.getElementById('instructions-modal');
        const correctAnswers = instructionsData[randomLayout].correctAnswers;
        const selectedAnswers = Array.from(
          document.querySelectorAll(
            "#instructions-modal input[type='checkbox']:checked"
          )
        ).map((checkbox) => checkbox.value);

        if (
          selectedAnswers.length === correctAnswers.length &&
          correctAnswers.every((answer) => selectedAnswers.includes(answer))
        ) {
          document.getElementById('error-popup').style.display = 'none';
          document.getElementById('instructions-modal').style.display = 'none';
          initializeVideo();
        } else {
          // show error message once the user selects wrong answers
          showErrorMessage(
            'Incorrect options! Kindly review the instructions above carefully and select the correct options before you proceed to watch the lecture.'
          );
        }
      });

      // Function to show error message for incorrect answers
      function showErrorMessage(message) {
        const errorPopup = document.getElementById('error-popup');
        errorPopup.textContent = message;
        errorPopup.style.display = 'block'; // Show the error message

        // Hide the error message after 5 seconds
        setTimeout(() => {
          errorPopup.style.display = 'none';
        }, 7000); // Hide after 5 seconds
      }

      // Function to display modal with dynamic content
      function showInstructions(layoutKey) {
        const modal = document.getElementById('instructions-modal');
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');

        // Populate modal with data
        const data = instructionsData[layoutKey];
        if (data) {
          title.textContent = data.title;
          content.innerHTML = data.content;
          modal.style.display = 'block';
        } else {
          console.error(`No instructions found for layout: ${layoutKey}`);
        }
      }

      // Initiate video
      function initializeVideo() {
        const videoContainer = document.getElementById('video');
        const textBoxes = document.getElementById('note-response-container');
        const responseContainer = document.getElementById('responseBox');
        const notesContainer = document.getElementById('noteBox');

        // Adjust layout based on the random choice
        if (randomLayout === '1') {
          videoContainer.style.height = '60vh'; //100
          videoContainer.style.display = 'block';
          textBoxes.style.display = 'none'; // Hide text box
          document.getElementById('container2').style.position = '';
        } else if (randomLayout === '2') {
          document.getElementById('container2').style.position = '';
          videoContainer.style.height = '60vh'; // make the video half screen
          videoContainer.style.display = 'block';
          textBoxes.style.display = 'flex'; // Show text box below
          textBoxes.style.height = '30vh';
          textBoxes.style.width = '100%';
          textBoxes.style.marginTop = '5vh';
        } else if (randomLayout === '3') {
          videoContainer.style.height = '60vh'; //100
          videoContainer.style.display = 'block';
          textBoxes.style.display = 'none'; // Don't show text box below
        } else {
          videoContainer.style.height = '60vh'; // make the video half screen
          videoContainer.style.display = 'block';
          textBoxes.style.display = 'flex'; // Show text box below
          textBoxes.style.height = '30vh';
          textBoxes.style.width = '100%';
          textBoxes.style.marginTop = '5vh';
        }

        player = new YT.Player('video', {
          height: '100%',
          width: '100%',
          //videoId: 'D9N7QaIOkG8', // video ID
          videoId: 'sCzRm3nKXa8',
          playerVars: {
            playsinline: 1,
            controls: 0, //Video controls, 0 means no controls
            iv_load_policy: 1,
            enablejsapi: 3,
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });
      }

      function onPlayerReady(event) {
        videoDuration = event.target.getDuration();
        const segmentDuration = videoDuration / additionalQuestions.length;
        questionPauseTimes = evenlyDistributedPauseTimes(
          numPauses,
          videoDuration
        );
        event.target.playVideo();

        // Generate random display times evenly distributed
        for (let i = 0; i < additionalQuestions.length; i++) {
          const randomOffset = Math.random() * (segmentDuration / 2);
          displayTimes.push(i * segmentDuration + randomOffset);
        }

        // Sort display times to ensure sequential order
        displayTimes.sort((a, b) => a - b);

        // Start checking for message display
        setInterval(checkAnddisplayAdditionalQuestion, 500);
      }

      let currentPauseIndex = 0;

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          if (currentPauseIndex < numPauses) {
            const checkPauseInterval = setInterval(() => {
              const currentTime = Math.round(player.getCurrentTime());
              if (currentTime == questionPauseTimes[currentPauseIndex]) {
                // Save notes before pausing the video
                saveNotesToFirebase();
                pauseVideoAndDisplayQuestion(currentPauseIndex);
                currentPauseIndex++;
                clearInterval(checkPauseInterval); // Stop checking once the pause is triggered
              }
            }, 1000); // Check every second
          }
        } else if (event.data == YT.PlayerState.ENDED) {
          setTimeout(() => {
            // Save the notes at the end of the video
            saveNotesToFirebase();
            window.close();
          }, 100);
        }
      }

      function pauseVideoAndDisplayQuestion() {
        const container2 = document.getElementById('container2');
        player.pauseVideo();
        container2.style.display = 'block';
        if (randomLayout == '1' || randomLayout === '2') {
          container2.style.transform = 'translate(-50%, -50%)';
          container2.style.top = '50%';
          container2.style.left = '50%';
        }
        if (randomLayout == '1' || randomLayout === '3') {
          document.getElementById('video-overlay').style.height = '100vh';
        }
        document.getElementById('video-overlay').style.display = 'block';
      }

      function evenlyDistributedPauseTimes(numPauses, videoDuration) {
        const pauseTimes = [];
        for (let i = 1; i <= numPauses; i++) {
          pauseTimes.push(
            Math.floor(
              Math.random() * (videoDuration / numPauses) +
                (i - 1) * (videoDuration / numPauses)
            )
          );
        }
        return pauseTimes;
      }

      // capture user responses onsubmit (for the question that pauses the video)
      submitButton.addEventListener('click', () => {
        const userAnswer1 = answerInput1.value;
        const userAnswer2 = answerInput2.value;
        const A = document.getElementById('A');
        const B = document.getElementById('B');

        // Check probe responses and alert participants
        if (A.checked || B.checked) {
          if (userAnswer1.length > 1 && !A.checked) {
            alert('Please select option A.');
          } else if (userAnswer2 && !B.checked) {
            alert('Please select option B.');
          } else if (!userAnswer1 && A.checked) {
            // inform participants to explain their choice
            alert('Please specify in a phrase or sentence to continue.');
          } else if (!userAnswer2 && B.checked) {
            // inform participants to explain their choice
            alert('Please specify in a phrase or sentence to continue.');
          } else {
            saveQuestionResponses(
              userAnswer1,
              userAnswer2,
              A.checked,
              B.checked
            );
            // clear the input fields
            answerInput1.value = '';
            answerInput2.value = '';
            const choices = document.getElementsByName('choice');
            for (var i = 0; i < choices.length; i++) {
              choices[i].checked = false;
            }
            container2.style.display = 'none';
            document.getElementById('video-overlay').style.display = 'none';
            player.playVideo();
          }
        } else {
          // inform participants to choose an option
          alert(
            'Please select one or both options (if they apply) to continue.'
          );
        }
      });

      // save additional question responses
      async function saveAdditionalQuestionResponses(params) {
        const question = document.getElementById('qtn');
        if (params.length > 1) {
          try {
            // collection to save additional qtn responses
            await addDoc(collection(db, 'ChatResponses'), {
              userId: userID.value,
              response: params,
              question: question.textContent,
              scenario: randomLayout,
              timestamp: new Date().toISOString(),
            });
            responseBox.value = '';
          } catch (error) {
            responseBox.value = '';
            console.error('Error saving final data: ', error);
          }
        } else {
          responseBox.value = '';
        }
        responseBox.value = '';
      }

      // capture response for additional questions and alert participants submit and
      additionalQtnBtn.addEventListener('click', () => {
        const response = responseBox.value;
        if (response.length < 10) {
          alert('Please provide a more detailed response');
        } else {
          saveAdditionalQuestionResponses(response);
          const questionContainer = document.getElementById('container1');
          questionContainer.style.display = 'none';
        }
      });

      // save responses to firebase
      async function saveQuestionResponses(answer1, answer2, isA, isB) {
        try {
          await addDoc(collection(db, 'ThoughtProbes'), {
            userId: userID.value,
            responses: {
              A: isA ? answer1 : null,
              B: isB ? answer2 : null,
            },
            timestamp: new Date().toISOString(),
            videoTime: Math.floor(player.getCurrentTime()),
          });
        } catch (error) {
          console.error('Error saving responses: ', error);
        }
      }

      // Capture the notes (id for firebase)
      async function saveNotesToFirebase() {
        const noteBox = document.getElementById('noteBox').value;
        try {
          await addDoc(collection(db, 'notes'), {
            userId: userID.value,
            notes: noteBox,
            scenario: randomLayout,
            timestamp: new Date().toISOString(),
          });
        } catch (error) {
          console.error('Error saving final data: ', error);
        }
      }

      // randomly display additional question
      function checkAnddisplayAdditionalQuestion() {
        const currentTime = player.getCurrentTime();

        if (randomLayout === '1' || randomLayout === '2') {
          console.log(
            'Skipping additional questions display because it is video scenario ',
            randomLayout
          );
        } else {
          if (
            currentQuestionIndex < additionalQuestions.length &&
            currentTime >= displayTimes[currentQuestionIndex]
          ) {
            displayAdditionalQuestion(
              additionalQuestions[currentQuestionIndex]
            );
            currentQuestionIndex++;
          }
        }
      }

      // Display additional question
      function displayAdditionalQuestion(message) {
        const container1 = document.getElementById('container1');
        const qtn = document.getElementById('qtn');
        qtn.textContent = message;
        container1.style.display = 'block';

        setTimeout(() => {
          // save whatever is in the text area if the question disappears before the user clicking submit
          saveAdditionalQuestionResponses(responseBox.value);
          container1.style.display = 'none';
        }, 60000); // Display message for 60 seconds
      }

      async function updateAndReturnMaxScenario() {
        try {
          const docRef = doc(db, 'scenarios', 'scenarios');
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            console.error('Document not found!');
            return;
          }

          const data = docSnap.data();
          const fields = ['S1', 'S2', 'S3', 'S4'];
          const values = fields.map((field) => data[field]);

          // Find the maximum value among the 4
          const maxValue = Math.max(...values);

          // Find indexes of the fields that have the maximum value
          const maxIndexes = values.reduce((acc, value, index) => {
            if (value === maxValue) {
              acc.push(index);
            }
            return acc;
          }, []);

          const selectedIndex =
            maxIndexes[Math.floor(Math.random() * maxIndexes.length)];
          const selectedField = fields[selectedIndex];

          // Reduce the selected value by 1
          const newValue = maxValue - 1;

          await updateDoc(docRef, { [selectedField]: newValue });
          return selectedField;
        } catch (error) {
          console.error('Error updating the maximum value:', error);
        }
      }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
  </body>
</html>
